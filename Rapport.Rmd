---
title: "Rapport"
author: "Ai-Ling Nguyen Bonnet & Elena Roques"
date: "2023-12-09"
output: html_document
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr)
library(rstatix)
library(visdat)
```

# Biostatistique : Etude du diabète

### Ai-Ling Nguyen Bonnet & Eléna Roques

```{r}
data <- read.csv('diabetes.csv')

#On sépare les labels des variables 
X = data[, - NCOL(data)]
y = data[, NCOL(data)] 
```

# Question 0 - Prétraitement des données

```{r Données manquantes}
vis_miss(data[,-1])
```

# Question 1 - Analyse exploratoire des données

## 1.1 - Distribution des variables

1.1.
Représenter la distribution de chaque variable explicative conditionnée par la variable diabetes.
Observet- on des différences significatives ?
En utilisant les tests statistiques qui conviennent (test de student, test du χ2, . . . ), vous justifierez soigneusement vos réponses en vous appuyant sur des critères de p-value ou autre intervalle de confiance.
Dans toute la suite, vous travaillerez sur les données standardisées

Voir <https://www.datanovia.com/en/fr/lessons/test-t-dans-r/#t-test-pour-echantillons-independants> pour le t - test

Note : Le *pedigree* est un score mesurant le risque familial du diabète.

```{r Moyennes}
data %>%
  group_by(diabetes) %>%
  summarise_at( c("pregnant", "glucose", "pressure", "triceps", "insulin", "mass","pedigree","age"),.f = list(mean = mean), na.rm = TRUE)
  #summarise_all(sd,na.rm = TRUE)
  #get_summary_stats(glucose, type = "mean_sd")
```

```{r Variances}
data %>%
  group_by(diabetes) %>%
  summarise_at( c("pregnant", "glucose", "pressure", "triceps", "insulin", "mass","pedigree","age"),.f = list(sd = sd), na.rm = TRUE)
```

### Représentation des distributions

```{r, echo = TRUE, fig.align = 'center', fig.height = 7.5, fig.width = 7.5}
data2 <- melt(data, id = "diabetes") 
ggplot(data = data2, aes(x = diabetes, y = value, color = diabetes)) + 
  geom_boxplot(col = "black", show.legend = FALSE, outlier.colour = NA) + theme_bw() +
  geom_point(shape = 1, 
             position = position_jitterdodge(dodge.width = .6, 
                                             jitter.width = .8), 
             size = 1.8, alpha = 1, show.legend = FALSE) +
  facet_wrap(. ~ variable, scales = "free") +
  theme(strip.background = element_rect(colour = "black", fill = "white"),
        strip.text.x = element_text(size = 11),
        axis.text = element_text(size = 9), axis.title = element_text(size = 0),
        legend.position = "bottom") + xlab("") + ylab("") +
  scale_color_manual(values = c("springgreen4","firebrick3"))
```

### Test t

On a deux groupes selon le diabète: les négatifs, *neg*, et les positifs,*pos*, dont on voudrait regarder les différences de moyenne.
Pour cela, un test t de Student ou de Welch peut-être pertinent, pourvu que les conditions suivantes soient remplies:

1.  Indépendance des observations. Chaque sujet ne doit appartenir qu'à un seul groupe. Il n'y a aucun lien entre les observations de chaque groupe. C'est bien vérifié dans notre cas, puisque les observations ne peuvent avoir qu'un seul label *diabetes* (*pos* ou *neg*). Les observations sont faites sur des femmes différentes, supposées sans lien.
2.  Aucune valeur aberrante significative dans les deux groupes
3.  Normalité. les données pour chaque groupe devraient être distribuées approximativement normalement.

Le test de Student suppose que les variances entre les deux groupes sont similaires, ce qui n'est pas le cas du test de Welch.

#### Valeurs aberrantes

```{r Valeurs aberrantes}
# Variables à tester
variables_a_tester <- c("pregnant", "glucose", "pressure", "triceps", "insulin", "mass", "pedigree", "age")

# Utiliser la fonction map() pour identifier les outliers pour chaque variable
outliers_list <- map(variables_a_tester, ~ data %>%
                        group_by(diabetes) %>%
                        identify_outliers(.x)%>%
                        mutate(variable = .x))

outliers_combined <- bind_rows(outliers_list, .id="Variables")%>%
  arrange(ID) %>%
  select(ID, variable,everything(), -c(Variables))%>%
  filter(is.extreme == TRUE) 
print(outliers_combined)

# Calculer le nombre de valeurs différentes dans la colonne "ID"
num_outliers <- outliers_combined %>%
  summarize(num_outliers= n_distinct(ID))

print(num_outliers)
```

Il y a 19 observations aberrantes extrêmes.
On les enlèvera de *data*.
On peut considérer qu'il n'y pas de valeurs aberrantes sur l'age ou la masse ?

```{r}
#data<- anti_join(data, outliers_combined, by = "ID")
```

#### **Normalité par groupes**

On vérifie, pour chaque variable, si les groupes de données suivent une loi normale.
On utilise à cet effet le test de Shapiro - Wilk.
Si la p-value est inférieure à 0.005, on considère que les données ne suivent pas une loi normale.

```{r Shapiro-Wilk test}
library(dplyr)
#library(outliers)
library(purrr)

# Utiliser la fonction map() pour effectuer le test de Shapiro-Wilk sur chaque variable
shapiro_tests <- map(variables_a_tester, ~ data %>%
                      group_by(diabetes) %>%
                      summarise(p_value = shapiro.test(.[[.x]])$p.value) %>%
                      mutate(variable = .x)%>%
                      select(variable, diabetes, p_value))

# Combinez les résultats dans un tableau
shapiro_combine <- bind_rows(shapiro_tests)

# Afficher le tableau combiné
print(shapiro_combine)
```

#### t -test

Pour évaluer les différences entre les deux groupes *pos* et *neg* selon les variables, on utilise un t-test.
Le t-test de Welch, utilisé par défaut par R, ne suppose pas les variances égales entre les groupes (contrairement au test de Student).

```{r}
# Variables à tester
variables_a_tester <- c("pregnant", "glucose", "pressure", "triceps", "insulin", "mass", "pedigree", "age")

stat_tests <- map(variables_a_tester, ~ data %>%
                    t_test(as.formula(paste(.x, "~ diabetes"))) %>%
                    add_significance())
resultats_combine <- bind_rows(stat_tests)%>% 
    select(-one_of("group1", "group2"))

print(resultats_combine)
```

Pour toutes les variables, la *p-value* est très faible (inférieure à 0.001) donc pour chaque variable, on peut rejeter l'hypothèse que les groupes *positifs* et *négatifs* ont la même moyenne.
Il est donc raisonnable de considérer que pour chaque variable, la différence entre les deux groupes est significative.

## 1.2 - Analyse en composante principale

On fait l'analyse en enlevant les valeurs NA.
[Voir question 0 pour remplacer les NA par des valeurs numériques].
On enlève la colonne ID qui n'a pas d'interêt explicatif.
Les données sont normalisées et centrées au sein de la fonction pca.

```{r, echo = TRUE, fig.align = 'center', fig.height = 5.5, fig.width = 5.5}
fit.pca <- prcomp(na.omit(X%>% 
                            select(-ID)), center = TRUE, scale = TRUE)
```

```{r}
summary(fit.pca)
```

```{r}
print(head(fit.pca$x))
```

```{r}
fviz_screeplot(fit.pca, addlabels=TRUE)
```

```{r}
fviz_pca_ind(fit.pca, habillage = data[, "diabetes"] # Il faut enlever les lignes avec des NA 
```

```{r}
fviz_pca_var(fit.pca, repel = TRUE)
```

### Interprétation 

## Question 2 - Prédiction par régression logistique
